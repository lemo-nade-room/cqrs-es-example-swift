# CONTEXT.md - ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆå¼•ãç¶™ãè³‡æ–™

## ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆæ¦‚è¦
Swiftã¨Vaporã§æ§‹ç¯‰ã•ã‚ŒãŸCQRSï¼ˆã‚³ãƒãƒ³ãƒ‰ã‚¯ã‚¨ãƒªè²¬ä»»åˆ†é›¢ï¼‰ã¨ã‚¤ãƒ™ãƒ³ãƒˆã‚½ãƒ¼ã‚·ãƒ³ã‚°ã®ã‚µãƒ³ãƒ—ãƒ«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã€‚AWS Lambdaã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã€ç‹¬ç«‹ã—ãŸã‚³ãƒãƒ³ãƒ‰ã‚µãƒ¼ãƒãƒ¼ã¨ã‚¯ã‚¨ãƒªã‚µãƒ¼ãƒãƒ¼ã‚’æŒã¤ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã€‚

## ğŸš€ æœ€æ–°ã®æ”¹è‰¯ï¼ˆ2025å¹´7æœˆ10æ—¥ï¼‰

### ç‹¬ç«‹ãƒ‡ãƒ—ãƒ­ã‚¤ã¨ãƒ“ãƒ«ãƒ‰é«˜é€ŸåŒ–ã®å®Ÿè£…çŠ¶æ³
**ç›®æ¨™**: Commandã¨QueryãŒç‹¬ç«‹ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤å¯èƒ½ã§ã€3åˆ†ä»¥å†…ã®ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚é–“

#### âœ… å®Œäº†ã—ãŸä½œæ¥­ï¼ˆ7æœˆ10æ—¥è¿½åŠ ï¼‰
1. **ç‹¬ç«‹ã—ãŸCodePipelineã®ä½œæˆ**
   - `command-deploy-pipeline`: Commandå´å°‚ç”¨
   - `query-deploy-pipeline`: Queryå´å°‚ç”¨
   - æ—§çµ±åˆãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ `stage-deploy-pipeline` ã¯æ®‹å­˜ï¼ˆå‰Šé™¤äºˆå®šï¼‰

2. **Dockerãƒ“ãƒ«ãƒ‰æœ€é©åŒ–**
   - BuildKitã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¦ãƒ³ãƒˆ (`--mount=type=cache`) ã‚’æœ‰åŠ¹åŒ–
   - ECRãƒ¬ã‚¸ã‚¹ãƒˆãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥ (`type=registry,mode=max`) ã‚’å®Ÿè£…
   - Swiftä¸¦åˆ—ãƒ“ãƒ«ãƒ‰ (`-Xswiftc -j8 -enable-batch-mode`) ã‚’æœ‰åŠ¹åŒ–
   - ä¾å­˜é–¢ä¿‚è§£æ±ºã¨ã‚½ãƒ¼ã‚¹ã‚³ãƒ”ãƒ¼ã®åˆ†é›¢ã«ã‚ˆã‚‹ã‚­ãƒ£ãƒƒã‚·ãƒ¥åŠ¹ç‡å‘ä¸Š

3. **å¤‰æ›´æ¤œçŸ¥ã‚·ã‚¹ãƒ†ãƒ **
   - `git diff --name-only HEAD~1..HEAD` ã«ã‚ˆã‚‹å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ¤œå‡º
   - ã‚µãƒ¼ãƒ“ã‚¹åˆ¥ã®å¤‰æ›´åˆ¤å®š (Command/Query/Infrastructure)
   - ä¸è¦ãªãƒ“ãƒ«ãƒ‰ã®ã‚¹ã‚­ãƒƒãƒ—æ©Ÿèƒ½ (`BUILD_SKIPPED` ç’°å¢ƒå¤‰æ•°)

4. **æ–°ã—ã„CodeBuildãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ**
   - `docker_build_command`: Commandå°‚ç”¨ãƒ“ãƒ«ãƒ‰
   - `docker_build_query`: Queryå°‚ç”¨ãƒ“ãƒ«ãƒ‰ 
   - `sam_package_command`: Commandç”¨SAMãƒ‘ãƒƒã‚±ãƒ¼ã‚¸
   - `sam_package_query`: Queryç”¨SAMãƒ‘ãƒƒã‚±ãƒ¼ã‚¸

5. **SAMãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ImageConfigè¿½åŠ ** (7æœˆ10æ—¥)
   - Lambda Web Adapterã¨ã®äº’æ›æ€§æ”¹å–„ã®ãŸã‚ã€ImageConfigã§COMMANDã‚’æ˜ç¤ºçš„ã«æŒ‡å®š
   - Command/Queryä¸¡æ–¹ã®Lambdaé–¢æ•°ã«é©ç”¨

#### ğŸ”„ ç¾åœ¨é€²è¡Œä¸­ï¼ˆ7æœˆ10æ—¥æ›´æ–°ï¼‰
- **Lambdaäº’æ›æ€§å•é¡Œã®è§£æ±º**: ImageConfigè¿½åŠ å¾Œã‚‚ã€ŒSource image is not validã€ã‚¨ãƒ©ãƒ¼ãŒç¶™ç¶š
- **æ ¹æœ¬çš„ãªè§£æ±ºç­–ã®æ¤œè¨**: Lambda Web Adapterã‚¢ãƒ—ãƒ­ãƒ¼ãƒã®è¦‹ç›´ã—ãŒå¿…è¦

#### ğŸ“‹ æ®‹ä½œæ¥­
1. **ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡Œçµæœã®ç¢ºèª**
   - ãƒ“ãƒ«ãƒ‰æ™‚é–“ã®æ¸¬å®šï¼ˆç›®æ¨™: 3åˆ†ä»¥å†…ï¼‰
   - ç‹¬ç«‹ãƒ‡ãƒ—ãƒ­ã‚¤ã®å‹•ä½œç¢ºèª
   - ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸå¾Œã®URLå‹•ä½œç¢ºèª

2. **æ—§ãƒªã‚½ãƒ¼ã‚¹ã®æ•´ç†**
   - æ—§ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ `stage-deploy-pipeline` ã®å‰Šé™¤
   - æ—§CodeBuildãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ `docker_build_and_push`, `sam_package` ã®å‰Šé™¤

#### ğŸ”§ å®Ÿè£…æ¸ˆã¿ã®æŠ€è¡“è©³ç´°

**Dockerfileæœ€é©åŒ–** (`syntax=docker/dockerfile:1`):
```dockerfile
# BuildKitã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¦ãƒ³ãƒˆ
RUN --mount=type=cache,target=/root/.cache \
    --mount=type=cache,target=/build/.build \
    swift build -c release --product CommandServer \
    -Xswiftc -j8 -Xswiftc -enable-batch-mode
```

**BuildSpecå¤‰æ›´æ¤œçŸ¥ãƒ­ã‚¸ãƒƒã‚¯**:
```yaml
# å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ¤œå‡º
CHANGED_FILES=$(git diff --name-only HEAD~1..HEAD)
if echo "$CHANGED_FILES" | grep -E "(Server/Sources/$SERVICE_NAME/|Server/Package\.swift)"; then
  RELEVANT_CHANGES=true
fi
```

**ECRã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥**:
```yaml
docker buildx build \
  --cache-from type=registry,ref=$CACHE_REF \
  --cache-to type=registry,ref=$CACHE_REF,mode=max \
  --push
```

## CI/CDãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æ§‹æˆ

### AWS CodePipelineã«ã‚ˆã‚‹è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤
**æ³¨æ„**: GitHub Actionsã¯ä½¿ç”¨ã—ã¦ã„ã¾ã›ã‚“ã€‚AWS CodePipelineã‚’ä½¿ç”¨ã€‚

#### ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã‚¹ãƒ†ãƒ¼ã‚¸
1. **Source Stage**
   - ãƒªãƒã‚¸ãƒˆãƒª: `lemo-nade-room/cqrs-es-example-swift`
   - ãƒ–ãƒ©ãƒ³ãƒ: `main`
   - æ¥ç¶š: AWS CodeStar Connections (GitHubé€£æº)

2. **Build Stage** (ä¸¦åˆ—å®Ÿè¡Œ)
   - **CommandBuild**
     - Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰: `/Server/Sources/Command/Dockerfile`
     - ECRãƒªãƒã‚¸ãƒˆãƒª: `command-server-function`
     - ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£: ARM (amazonlinux-aarch64)
     - ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: 15åˆ†
   
   - **QueryBuild**
     - Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰: `/Server/Sources/Query/Dockerfile`
     - ECRãƒªãƒã‚¸ãƒˆãƒª: `query-server-function`
     - ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£: ARM (amazonlinux-aarch64)
     - ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: 15åˆ†
   
   - **SAMPackage**
     - SAMãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ³ã‚°
     - å‡ºåŠ›: `packaged.yaml`
     - ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: 5åˆ†

3. **Deploy Stage**
   - CloudFormationã‚¹ã‚¿ãƒƒã‚¯: `Stage`
   - ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ¢ãƒ¼ãƒ‰: `REPLACE_ON_FAILURE`
   - æ¨©é™: `CAPABILITY_IAM`, `CAPABILITY_AUTO_EXPAND`

### ãƒ‡ãƒ—ãƒ­ã‚¤æƒ…å ±

#### æ–°ã—ã„ç‹¬ç«‹ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ï¼ˆæ¨å¥¨ï¼‰
- **Commandç”¨**: `command-deploy-pipeline`
- **Queryç”¨**: `query-deploy-pipeline`
- **ãƒªãƒ¼ã‚¸ãƒ§ãƒ³**: `ap-northeast-1` (æ±äº¬)
- **ç›®æ¨™ãƒ“ãƒ«ãƒ‰æ™‚é–“**: 3åˆ†ä»¥å†…ï¼ˆå®Ÿæ¸¬ä¸­ï¼‰
- **ãƒˆãƒªã‚¬ãƒ¼**: `main`ãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ã§è©²å½“ã‚µãƒ¼ãƒ“ã‚¹ã®ã¿è‡ªå‹•å®Ÿè¡Œ
- **å¤‰æ›´æ¤œçŸ¥**: `git diff`ãƒ™ãƒ¼ã‚¹ã®å·®åˆ†æ¤œå‡ºã§ä¸è¦ãƒ“ãƒ«ãƒ‰ã‚’ã‚¹ã‚­ãƒƒãƒ—

#### æ—§çµ±åˆãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ï¼ˆå‰Šé™¤äºˆå®šï¼‰
- **ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å**: `stage-deploy-pipeline`
- **ãƒ“ãƒ«ãƒ‰æ™‚é–“**: ç´„15åˆ†ï¼ˆæ”¹å–„å‰ï¼‰
- **å•é¡Œ**: å°ã•ãªå¤‰æ›´ã§ã‚‚ä¸¡ã‚µãƒ¼ãƒ“ã‚¹å…¨ä½“ã‚’ãƒ“ãƒ«ãƒ‰

### CodePipelineãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°

#### æ–°ã—ã„ç‹¬ç«‹ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ï¼ˆ2025å¹´7æœˆ9æ—¥ã€œï¼‰
```bash
# Commandç”¨ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®çŠ¶æ…‹ç¢ºèª
aws codepipeline get-pipeline-state --name command-deploy-pipeline --region ap-northeast-1
aws codepipeline list-pipeline-executions --pipeline-name command-deploy-pipeline --region ap-northeast-1

# Queryç”¨ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®çŠ¶æ…‹ç¢ºèª
aws codepipeline get-pipeline-state --name query-deploy-pipeline --region ap-northeast-1
aws codepipeline list-pipeline-executions --pipeline-name query-deploy-pipeline --region ap-northeast-1

# å®Ÿè¡Œæ™‚é–“ã¨ãƒ“ãƒ«ãƒ‰è©³ç´°ã®ç¢ºèª
aws codebuild batch-get-builds --ids <BUILD_ID> --region ap-northeast-1
```

#### æ—§çµ±åˆãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ï¼ˆå‰Šé™¤äºˆå®šï¼‰
```bash
# ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®ç¾åœ¨ã®çŠ¶æ…‹ã‚’ç¢ºèª
aws codepipeline get-pipeline-state --name stage-deploy-pipeline --region ap-northeast-1

# æœ€è¿‘ã®å®Ÿè¡Œå±¥æ­´ã‚’è¡¨ç¤ºï¼ˆæœ€å¤§10ä»¶ï¼‰
aws codepipeline list-pipeline-executions --pipeline-name stage-deploy-pipeline --region ap-northeast-1 --max-results 10

# ç‰¹å®šã®å®Ÿè¡Œã®è©³ç´°ã‚’ç¢ºèª
aws codepipeline get-pipeline-execution --pipeline-name stage-deploy-pipeline --pipeline-execution-id <å®Ÿè¡ŒID> --region ap-northeast-1

# å„ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®è©³ç´°ãªå®Ÿè¡ŒçŠ¶æ…‹
aws codepipeline list-action-executions --pipeline-name stage-deploy-pipeline --region ap-northeast-1 --filter pipelineExecutionId=<å®Ÿè¡ŒID>
```

#### ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡Œã®è©³ç´°
- **å®Ÿè¡Œãƒ¢ãƒ¼ãƒ‰**: `SUPERSEDED`ï¼ˆæ–°ã—ã„å®Ÿè¡ŒãŒå§‹ã¾ã‚‹ã¨å¤ã„å®Ÿè¡Œã¯ä¸Šæ›¸ãã•ã‚Œã‚‹ï¼‰
- **ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆä¿å­˜**: `stage-deploy-codepipeline-bucket-983760593510`
- **å®Ÿè¡Œå±¥æ­´**: å„å®Ÿè¡Œã«ã¯ä¸€æ„ã®IDãŒä»˜ä¸ã•ã‚Œã€ã‚³ãƒŸãƒƒãƒˆæƒ…å ±ã¨å…±ã«è¨˜éŒ²ã•ã‚Œã‚‹
- **ç‹¬ç«‹å®Ÿè¡Œ**: Command/Queryã¯äº’ã„ã«å½±éŸ¿ã›ãšä¸¦åˆ—å®Ÿè¡Œå¯èƒ½
- **å¤‰æ›´æ¤œçŸ¥**: ãƒ•ã‚¡ã‚¤ãƒ«å¤‰æ›´ãƒ‘ã‚¿ãƒ¼ãƒ³ã«åŸºã¥ãè‡ªå‹•ã‚¹ã‚­ãƒƒãƒ—æ©Ÿèƒ½

## ã‚µãƒ¼ãƒãƒ¼ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£

### Lambdaé–¢æ•°æ§‹æˆ
1. **CommandServerFunction**
   - å½¹å‰²: æ›¸ãè¾¼ã¿æ“ä½œå‡¦ç†ï¼ˆCQRSã®Commandå´ï¼‰
   - ãƒ«ãƒ¼ãƒˆ: `/command/{proxy+}`
   - ã‚µãƒ¼ãƒ“ã‚¹å: `CommandServer`
   - ãƒ¡ãƒ¢ãƒª: 128MB
   - ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: 10ç§’

2. **QueryServerFunction**
   - å½¹å‰²: èª­ã¿å–ã‚Šæ“ä½œå‡¦ç†ï¼ˆCQRSã®Queryå´ï¼‰
   - ãƒ«ãƒ¼ãƒˆ: `/query/{proxy+}`
   - ã‚µãƒ¼ãƒ“ã‚¹å: `QueryServer`
   - ãƒ¡ãƒ¢ãƒª: 128MB
   - ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: 10ç§’

### API Gateway
- ã‚¿ã‚¤ãƒ—: HTTP API
- åå‰: `CQRS ES Example Swift Server`
- ã‚¹ãƒ†ãƒ¼ã‚¸: `Stage`
- ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ: `https://nmyifhbudh.execute-api.ap-northeast-1.amazonaws.com/Stage`

### ç›£è¦–ãƒ»ãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°è¨­å®š
- **AWS X-Ray**: æœ‰åŠ¹åŒ–æ¸ˆã¿
- **OpenTelemetry**: X-Ray OTLPã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã¨çµ±åˆ
- **Application Signals**: æœ‰åŠ¹
- **CloudWatch Logs**: JSONå½¢å¼ã€DEBUGãƒ¬ãƒ™ãƒ«
- **ãƒˆãƒ¬ãƒ¼ã‚¹ä¼æ¬**: X-Rayå½¢å¼

### ç’°å¢ƒå¤‰æ•°ï¼ˆLambdaï¼‰
```yaml
AWS_XRAY_CONTEXT_MISSING: LOG_ERROR
OTEL_EXPORTER_OTLP_ENDPOINT: https://xray.ap-northeast-1.amazonaws.com
OTEL_PROPAGATORS: xray
OTEL_METRICS_EXPORTER: none
OTEL_AWS_APPLICATION_SIGNALS_ENABLED: true
OTEL_RESOURCE_ATTRIBUTES: service.name={CommandServer|QueryServer}
```

## ã‚¤ãƒ³ãƒ•ãƒ©ãƒªã‚½ãƒ¼ã‚¹

### ECRãƒªãƒã‚¸ãƒˆãƒª
- `command-server-function`: CommandServerã®Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ä¿å­˜
- `query-server-function`: QueryServerã®Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ä¿å­˜
- ãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ãƒãƒªã‚·ãƒ¼: ã‚¿ã‚°ãªã—ã‚¤ãƒ¡ãƒ¼ã‚¸ã¯1æ—¥å¾Œã«å‰Šé™¤
- ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¹ã‚­ãƒ£ãƒ³: ãƒ—ãƒƒã‚·ãƒ¥æ™‚ã«è‡ªå‹•å®Ÿè¡Œ

### IAMãƒ­ãƒ¼ãƒ«
- **super_role**: PowerUserAccess + IAMFullAccessã‚’æŒã¤å¼·åŠ›ãªãƒ­ãƒ¼ãƒ«
  - ä½¿ç”¨å…ˆ: CodeBuildã€CodePipelineã€CloudFormationã€Lambda
- Lambdaå®Ÿè¡Œãƒ­ãƒ¼ãƒ«: X-Rayã€CloudWatch Metricsã®è¿½åŠ æ¨©é™

### S3ãƒã‚±ãƒƒãƒˆ
- `cqrs-es-example-swift-artifacts-bucket`: SAMã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆä¿å­˜ç”¨
- `stage-deploy-codepipeline-bucket-983760593510`: CodePipelineã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆä¿å­˜ç”¨ï¼ˆè‡ªå‹•ç”Ÿæˆï¼‰

## é–‹ç™ºç’°å¢ƒ

### ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™º
- Docker Composeè¨­å®š: `/Server/compose.yaml`
- Jaegerãƒˆãƒ¬ãƒ¼ã‚·ãƒ³ã‚°: http://localhost:16686
- CommandServer: http://localhost:3001/command
- QueryServer: http://localhost:3002/query

### å¿…è¦ãªãƒ„ãƒ¼ãƒ«
- Swift 6.1
- Docker Compose v2
- OpenTofu (Terraformã®ä»£æ›¿)
- AWS SAM CLI
- GitHub MCPã€AWS MCP (ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆç”¨)

### ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯
```bash
# Swiftãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
swift format lint -r .

# ãƒ“ãƒ«ãƒ‰
swift build

# ãƒ†ã‚¹ãƒˆï¼ˆ12ãƒ†ã‚¹ãƒˆï¼‰
swift test

# ã‚¤ãƒ³ãƒ•ãƒ©
tofu fmt                # Terraform
sam validate --lint     # SAM

# OpenAPIæ¤œè¨¼
openapi-generator validate -i ./Server/Sources/Command/Server/openapi.yaml
```

## OpenAPIä»•æ§˜

### CommandServer
- OpenAPI 3.0.3
- ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯: `GET /v1/healthcheck`
- ãƒ­ãƒ¼ã‚«ãƒ«: http://127.0.0.1:3001/command
- ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°: https://nmyifhbudh.execute-api.ap-northeast-1.amazonaws.com/Stage/command

### QueryServer
- OpenAPIä»•æ§˜ãƒ•ã‚¡ã‚¤ãƒ«ã¯ç¾åœ¨ãªã—

## ç¾åœ¨ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ï¼ˆ2025å¹´7æœˆ10æ—¥ 10:50æ›´æ–°ï¼‰

### ğŸ¯ ç‹¬ç«‹ãƒ‡ãƒ—ãƒ­ã‚¤ã¨é«˜é€ŸåŒ–ã®å®Ÿè£…çŠ¶æ³

#### âœ… å®Œäº†ã—ãŸå®Ÿè£…
1. **ç‹¬ç«‹ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æ§‹ç¯‰**
   - Command/Queryç”¨ã®ç‹¬ç«‹ã—ãŸCodePipelineä½œæˆå®Œäº†
   - å¤‰æ›´æ¤œçŸ¥ã‚·ã‚¹ãƒ†ãƒ ã§ä¸è¦ãªãƒ“ãƒ«ãƒ‰ã‚’ã‚¹ã‚­ãƒƒãƒ—
   - git diffãƒ™ãƒ¼ã‚¹ã§ã‚µãƒ¼ãƒ“ã‚¹åˆ¥ã®å¤‰æ›´ã‚’åˆ¤å®š

2. **ãƒ“ãƒ«ãƒ‰é«˜é€ŸåŒ–ã®æˆæœ**
   - **åˆå›ãƒ“ãƒ«ãƒ‰**: ç´„9åˆ†ï¼ˆCommand: 9åˆ†21ç§’ã€Query: 9åˆ†1ç§’ï¼‰
   - **ã‚­ãƒ£ãƒƒã‚·ãƒ¥åˆ©ç”¨æ™‚**: 16-18ç§’ï¼ˆåŠ‡çš„ãªæ”¹å–„ï¼95%ä»¥ä¸Šå‰Šæ¸›ï¼‰
   - BuildKitã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¨ECRãƒ¬ã‚¸ã‚¹ãƒˆãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥å®Ÿè£…

3. **Dockeræœ€é©åŒ–**
   - BuildKitã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¦ãƒ³ãƒˆå®Ÿè£…
   - Swiftä¸¦åˆ—ãƒ“ãƒ«ãƒ‰ï¼ˆ-j8ï¼‰æœ‰åŠ¹åŒ–
   - ä¾å­˜é–¢ä¿‚ã¨ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã®åˆ†é›¢ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥åŠ¹ç‡å‘ä¸Š

#### âŒ ç¾åœ¨ã®å•é¡Œï¼ˆ7æœˆ10æ—¥ 10:50æ›´æ–°ï¼‰
1. **Lambdaäº’æ›æ€§ã‚¨ãƒ©ãƒ¼ï¼ˆæœªè§£æ±ºï¼‰**
   - ã‚¨ãƒ©ãƒ¼: "Source image 983760593510.dkr.ecr.ap-northeast-1.amazonaws.com/command-server-function is not valid"
   - è©¦ã—ãŸå¯¾ç­–:
     - buildxã‹ã‚‰docker buildã¸ã®åˆ‡ã‚Šæ›¿ãˆ âŒ
     - ImageConfigè¨­å®šã®è¿½åŠ ï¼ˆEntryPoint, Command, WorkingDirectoryï¼‰ âŒ
     - Lambda Web Adapterã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆ0.9.0â†’0.9.1ï¼‰ âŒ
     - AWS LambdaåŸºæœ¬ã‚¤ãƒ¡ãƒ¼ã‚¸ï¼ˆal2023-arm64ï¼‰ã¸ã®å¤‰æ›´ âŒï¼ˆãƒ“ãƒ«ãƒ‰å¤±æ•—ï¼‰
     - Ubuntu 22.04ã¸ã®æˆ»ã—ã¨å„ç¨®èª¿æ•´ âŒ
   - å½±éŸ¿: CloudFormationãƒ‡ãƒ—ãƒ­ã‚¤ã§å¤±æ•—ï¼ˆUPDATE_ROLLBACK_COMPLETEï¼‰

2. **ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Ÿè¡ŒçŠ¶æ…‹**
   - æœ€æ–°å®Ÿè¡Œï¼ˆ7æœˆ10æ—¥ 10:44é–‹å§‹ï¼‰: 
     - ãƒ“ãƒ«ãƒ‰: é€²è¡Œä¸­ï¼ˆBuildKitã‚­ãƒ£ãƒƒã‚·ãƒ¥ç„¡åŠ¹åŒ–ã®å½±éŸ¿ã§æ™‚é–“å¢—åŠ ï¼‰
     - ãƒ‡ãƒ—ãƒ­ã‚¤: Lambdaäº’æ›æ€§ã‚¨ãƒ©ãƒ¼ã§å¤±æ•—ç¶™ç¶š
   - ç‹¬ç«‹ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å‹•ä½œ: ä¸¡æ–¹ãŒæ­£å¸¸ã«ä¸¦åˆ—å®Ÿè¡Œã•ã‚Œã‚‹ã“ã¨ã‚’ç¢ºèª
   - ç¾åœ¨ã®API: å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒç¨¼åƒä¸­ï¼ˆæœ€å¾Œã®æˆåŠŸãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ç‚¹ï¼‰

#### ğŸ” è©³ç´°ãªèª¿æŸ»çµæœ
1. **ECRã‚¤ãƒ¡ãƒ¼ã‚¸çŠ¶æ…‹**
   - ã‚¤ãƒ¡ãƒ¼ã‚¸ã¯æ­£ã—ããƒ—ãƒƒã‚·ãƒ¥æ¸ˆã¿ï¼ˆ18:18:31ï¼‰
   - IMAGE_URIã¯æ­£ã—ã„ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆå½¢å¼ã§å‡ºåŠ›
   - ä¾‹: `983760593510.dkr.ecr.ap-northeast-1.amazonaws.com/query-server-function@sha256:730cb9b52019e9d5353e46922f16b6bcbaab69aee547e3f6929c5245addb5b0f`

2. **ãƒ“ãƒ«ãƒ‰è¨­å®š**
   - docker buildã«åˆ‡ã‚Šæ›¿ãˆæ¸ˆã¿ï¼ˆbuildxç„¡åŠ¹åŒ–ï¼‰
   - `--platform linux/arm64`æŒ‡å®šã§ARMå¯¾å¿œ
   - ã‚­ãƒ£ãƒƒã‚·ãƒ¥æ©Ÿèƒ½ã¯ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ–

3. **ç›®æ¨™é”æˆçŠ¶æ³**
   - âœ… ãƒ“ãƒ«ãƒ‰æ™‚é–“: ã‚­ãƒ£ãƒƒã‚·ãƒ¥åˆ©ç”¨ã§ç›®æ¨™ã‚’å¤§å¹…ã«ä¸Šå›ã‚‹æ”¹å–„
   - âŒ å…¨ä½“æ™‚é–“: Lambdaäº’æ›æ€§ã‚¨ãƒ©ãƒ¼ã§ãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—ã®ãŸã‚æœªé”æˆ
   - âœ… ç‹¬ç«‹ãƒ‡ãƒ—ãƒ­ã‚¤: ä»•çµ„ã¿ã¯å®Œæˆã€ã‚¨ãƒ©ãƒ¼è§£æ±ºå¾Œã«å‹•ä½œç¢ºèªå¯èƒ½

## é‡è¦ãªæ³¨æ„äº‹é …

### .envãƒ•ã‚¡ã‚¤ãƒ«
**çµ¶å¯¾ã«ç·¨é›†ãƒ»å‰Šé™¤ã—ã¦ã¯ã„ã‘ãªã„**:
- `/claude/workspace/.env`: Claude Codeå‹•ä½œç”¨
- ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆã®`.env`: é‡è¦ãªè¨­å®š

### ãƒ‡ãƒ—ãƒ­ã‚¤æ™‚ã®æ³¨æ„
- `main`ãƒ–ãƒ©ãƒ³ãƒã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ã§è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤ãŒé–‹å§‹ã•ã‚Œã‚‹
- ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼ã®å ´åˆã€CloudFormationã‚¹ã‚¿ãƒƒã‚¯ãŒç½®ãæ›ãˆã‚‰ã‚Œã‚‹å¯èƒ½æ€§ãŒã‚ã‚‹
- X-Ray OTLPã¯å„ãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã§ä¸€åº¦æœ‰åŠ¹åŒ–ãŒå¿…è¦

### ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®ç‰¹å¾´
- å®Œå…¨ã‚µãƒ¼ãƒãƒ¼ãƒ¬ã‚¹ï¼ˆLambda + API Gatewayï¼‰
- CQRSãƒ‘ã‚¿ãƒ¼ãƒ³ã§èª­ã¿æ›¸ãã‚’åˆ†é›¢
- å„ã‚µãƒ¼ãƒãƒ¼ã¯ç‹¬ç«‹ã—ã¦ã‚¹ã‚±ãƒ¼ãƒ«å¯èƒ½
- ARMã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£æ¡ç”¨ã§ã‚³ã‚¹ãƒˆæœ€é©åŒ–

## Dockerãƒ“ãƒ«ãƒ‰é«˜é€ŸåŒ–æˆ¦ç•¥

### ç¾çŠ¶ã®èª²é¡Œ
- Server-Side Swiftã®Dockerãƒ“ãƒ«ãƒ‰ãŒç´„15åˆ†ã‹ã‹ã‚‹
- CodeBuildã®Largeã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½¿ç”¨ä¸­
- ç›®æ¨™: 1-3åˆ†ç¨‹åº¦ã¸ã®çŸ­ç¸®

### æ¨å¥¨ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ: BuildKit Remote Cacheï¼ˆECRä½¿ç”¨ï¼‰

#### 1. Dockerfileæœ€é©åŒ–
```dockerfile
FROM swiftlang/swift:6.0-jammy AS builder
WORKDIR /app

# ä¾å­˜è§£æ±ºã‚’å…ˆã«å®Ÿè¡Œï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ’ãƒƒãƒˆç‡å‘ä¸Šï¼‰
COPY Package.* ./
RUN --mount=type=cache,target=/root/.cache \
    --mount=type=cache,target=.build \
    swift package resolve

# ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã¯å¾Œã‹ã‚‰ã‚³ãƒ”ãƒ¼
COPY Sources/ ./Sources/
RUN --mount=type=cache,target=/root/.cache \
    --mount=type=cache,target=.build \
    swift build -c release -Xswiftc -enable-batch-mode

FROM swiftlang/swift:6.0-jammy-slim
COPY --from=builder /app/.build/release/MyApp /usr/bin/MyApp
ENTRYPOINT ["/usr/bin/MyApp"]
```

#### 2. buildspec.ymlè¨­å®š
```yaml
version: 0.2
env:
  variables:
    IMAGE_REPO: "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/myapp"
    CACHE_REF:  "${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com/myapp:cache"
phases:
  pre_build:
    commands:
      - aws ecr get-login-password --region $AWS_REGION \
        | docker login --username AWS --password-stdin ${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com
      - docker buildx create --use --name builder
  build:
    commands:
      - docker buildx build . \
          --platform linux/amd64 \
          --cache-from type=registry,ref=$CACHE_REF \
          --cache-to   type=registry,ref=$CACHE_REF,mode=max \
          -t $IMAGE_REPO:latest \
          --push
```

#### 3. é‡è¦ãªãƒã‚¤ãƒ³ãƒˆ
- **--mount=type=cache**: .buildãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã¨SwiftPMã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä¿æŒ
- **mode=max**: ä¸­é–“ãƒ¬ã‚¤ãƒ¤ã‚‚å…¨ã¦ã‚­ãƒ£ãƒƒã‚·ãƒ¥åŒ–ï¼ˆSwiftãƒ“ãƒ«ãƒ‰ã«åŠ¹æœçš„ï¼‰
- **ã‚­ãƒ£ãƒƒã‚·ãƒ¥å°‚ç”¨ã‚¿ã‚°**: `:cache`ã‚¿ã‚°ã§ã‚¢ãƒ—ãƒªæœ¬ä½“ã¨åˆ†é›¢

#### 4. ã‚³ã‚¹ãƒˆè©¦ç®—
- ECRã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸: $0.10/GB-æœˆï¼ˆ500MB/æœˆã¯ç„¡æ–™ï¼‰
- Swiftã‚¢ãƒ—ãƒªã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç´„2GB: $0.20/æœˆç¨‹åº¦
- ãƒ“ãƒ«ãƒ‰æ™‚é–“çŸ­ç¸®ã«ã‚ˆã‚‹ç¯€ç´„: 10åˆ†Ã—$0.02=$0.20 â†’ 3åˆ†Ã—$0.02=$0.06ï¼ˆç´„1/3ï¼‰

#### 5. è¿½åŠ ã®æœ€é©åŒ–ç­–
- **ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸ã®äº‹å‰ãƒ“ãƒ«ãƒ‰**: ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’å«ã‚€å°‚ç”¨ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚’é€±æ¬¡ã§æ›´æ–°
- **CodeBuildãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä½µç”¨**: `/root/.cache`ã¨`.build`ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ‘ã‚¹ã«è¿½åŠ 
- **ä¸¦åˆ—åº¦å‘ä¸Š**: `-Xswiftc -j8`ãªã©ã§ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«ä¸¦åˆ—æ•°ã‚’èª¿æ•´

### ä»£æ›¿æ¡ˆ: Docker Serveræ©Ÿèƒ½ï¼ˆ2025-05ä»¥é™ï¼‰
- CodeBuildã®æ°¸ç¶šã‚­ãƒ£ãƒƒã‚·ãƒ¥ä»˜ãå°‚ç”¨Dockerãƒ‡ãƒ¼ãƒ¢ãƒ³
- åŠ‡çš„ãªæ”¹å–„ä¾‹: 25åˆ†â†’16ç§’ï¼ˆ98%å‰Šæ¸›ï¼‰
- ã‚³ã‚¹ãƒˆ: image-server.medium $0.015/ç§’ï¼ˆç¨¼åƒæ™‚ã®ã¿ï¼‰
- ãŸã ã—å¸¸æ™‚èµ·å‹•ã‚³ã‚¹ãƒˆãŒç™ºç”Ÿã™ã‚‹ãŸã‚ã€å°è¦æ¨¡ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã¯ECRã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒæ¨å¥¨

### é‹ç”¨ä¸Šã®æ³¨æ„
- ECRãƒ©ã‚¤ãƒ•ã‚µã‚¤ã‚¯ãƒ«ãƒãƒªã‚·ãƒ¼ã§å¤ã„ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’14æ—¥ã§è‡ªå‹•å‰Šé™¤
- ã‚­ãƒ£ãƒƒã‚·ãƒ¥ç”¨ãƒªãƒã‚¸ãƒˆãƒªã¯ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚¹ã‚­ãƒ£ãƒ³ã‚’ç„¡åŠ¹åŒ–ã—ã¦ã‚³ã‚¹ãƒˆå‰Šæ¸›
- åˆå›ãƒ“ãƒ«ãƒ‰ã¯7-10åˆ†ã‹ã‹ã‚‹ãŒã€2å›ç›®ä»¥é™ã¯2-3åˆ†ã«çŸ­ç¸®å¯èƒ½

## ç‹¬ç«‹ãƒ‡ãƒ—ãƒ­ã‚¤ã®å‹•ä½œãƒ‘ã‚¿ãƒ¼ãƒ³

### ã‚·ãƒŠãƒªã‚ªåˆ¥ãƒ‡ãƒ—ãƒ­ã‚¤å‹•ä½œ
1. **Commandã®ã¿å¤‰æ›´**: `command-deploy-pipeline`ã®ã¿å®Ÿè¡Œ
2. **Queryã®ã¿å¤‰æ›´**: `query-deploy-pipeline`ã®ã¿å®Ÿè¡Œ  
3. **ä¸¡æ–¹å¤‰æ›´**: ä¸¡ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãŒä¸¦åˆ—å®Ÿè¡Œ
4. **ã‚¤ãƒ³ãƒ•ãƒ©å¤‰æ›´**: ä¸¡ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãŒå®Ÿè¡Œï¼ˆå®‰å…¨æ€§ã®ãŸã‚ï¼‰
5. **å¤‰æ›´ãªã—**: ä¸¡ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã¨ã‚‚ã‚¹ã‚­ãƒƒãƒ—

### ç¾åœ¨ã®ãƒ†ã‚¹ãƒˆçŠ¶æ³
- **æœ€æ–°ãƒ†ã‚¹ãƒˆ**: Queryå´ã® `configure.swift` ã‚’å¤‰æ›´ï¼ˆ"Query Running - v2 (Fast Deploy)"ï¼‰
- **ã‚³ãƒŸãƒƒãƒˆãƒãƒƒã‚·ãƒ¥**: `3c12540`
- **æœŸå¾…çµæœ**: `query-deploy-pipeline` ã®ã¿å®Ÿè¡Œã€`command-deploy-pipeline` ã¯ã‚¹ã‚­ãƒƒãƒ—
- **æ¸¬å®šé …ç›®**: å…¨ä½“å®Ÿè¡Œæ™‚é–“ï¼ˆç›®æ¨™3åˆ†ä»¥å†…ï¼‰

### API Gatewayç¢ºèª
- **ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ**: `https://nmyifhbudh.execute-api.ap-northeast-1.amazonaws.com`
- **Queryç¢ºèªURL**: `https://nmyifhbudh.execute-api.ap-northeast-1.amazonaws.com/Stage/query/healthcheck`
- **æœŸå¾…ãƒ¬ã‚¹ãƒãƒ³ã‚¹**: "Query Running - v2 (Fast Deploy)"

## Lambdaäº’æ›æ€§å•é¡Œã®åˆ†æã¨è§£æ±ºç­–

### å•é¡Œã®è©³ç´°
1. **ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸**: 
   ```
   Resource handler returned message: "Source image 983760593510.dkr.ecr.ap-northeast-1.amazonaws.com/query-server-function is not valid. 
   Provide a valid source image. (Service: Lambda, Status Code: 400)"
   ```

2. **ç™ºç”Ÿã‚¿ã‚¤ãƒŸãƒ³ã‚°**: CloudFormationã®Deployæ®µéšã§Lambdaé–¢æ•°ä½œæˆ/æ›´æ–°æ™‚

3. **è©¦ã—ãŸå¯¾ç­–ã¨çµæœ**:
   - âœ… buildxã‹ã‚‰docker buildã¸ã®åˆ‡ã‚Šæ›¿ãˆ â†’ å•é¡Œç¶™ç¶š
   - âœ… ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ æŒ‡å®šï¼ˆ--platform linux/arm64ï¼‰â†’ å•é¡Œç¶™ç¶š
   - âœ… ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ€ã‚¤ã‚¸ã‚§ã‚¹ãƒˆå½¢å¼ä½¿ç”¨ â†’ å•é¡Œç¶™ç¶š

### è€ƒãˆã‚‰ã‚Œã‚‹åŸå› ã¨æ¬¡ã®å¯¾ç­–

#### 1. **ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆå½¢å¼ã®å•é¡Œ**
- ç¾åœ¨: `application/vnd.docker.distribution.manifest.v2+json`
- Lambdaè¦ä»¶: OCIæ¨™æº–å½¢å¼ãŒå¿…è¦ãªå¯èƒ½æ€§
- **å¯¾ç­–**: Dockerfileã§ãƒãƒ«ãƒã‚¹ãƒ†ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰ã®æœ€é©åŒ–

#### 2. **ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸ã®å•é¡Œ**
- ç¾åœ¨ã®ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸ãŒLambdaéå¯¾å¿œã®å¯èƒ½æ€§
- **å¯¾ç­–**: AWSå…¬å¼ã®Lambdaç”¨ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸ã¸ã®å¤‰æ›´
  ```dockerfile
  FROM public.ecr.aws/lambda/provided:al2-arm64
  ```

#### 3. **ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®ä¸ä¸€è‡´**
- SAMãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¨Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ä¸ä¸€è‡´
- **å¯¾ç­–**: SAMãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§arm64ã‚’æ˜ç¤ºçš„ã«æŒ‡å®š

#### 4. **ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚µã‚¤ã‚ºã®å•é¡Œ**
- ç¾åœ¨: ç´„93MBï¼ˆæ¯”è¼ƒçš„å°ã•ã„ï¼‰
- **å¯¾ç­–**: ä¸è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤ã€æœ€å°é™ã®ãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã®ã¿å«ã‚ã‚‹

### æ¨å¥¨ã•ã‚Œã‚‹æ¬¡ã®ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆ7æœˆ10æ—¥æ›´æ–°ï¼‰

1. **Lambda Web Adapterã‹ã‚‰Swift AWS Lambda Runtimeã¸ã®ç§»è¡Œ**
   - å…¬å¼ã® `swift-server/swift-aws-lambda-runtime` ä½¿ç”¨ã‚’æ¤œè¨
   - Lambda Runtime APIã¨ã®ç›´æ¥çµ±åˆã§ã‚ˆã‚Šç¢ºå®Ÿãªå‹•ä½œ
   - Vaporã‚¢ãƒ—ãƒªã‚’Lambdaãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã¨ã—ã¦ãƒ©ãƒƒãƒ—

2. **SAMãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ç¢ºèª**
   - Architecturesè¨­å®šã®ç¢ºèª
   - PackageType: Imageã®è¨­å®šç¢ºèª
   - ImageConfigã®è¿½åŠ æ¤œè¨

3. **ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®ãƒ†ã‚¹ãƒˆ**
   - SAM localã§ã®ã‚¤ãƒ¡ãƒ¼ã‚¸å‹•ä½œç¢ºèª
   - docker run ã§ã®ç›´æ¥å®Ÿè¡Œãƒ†ã‚¹ãƒˆ

## ãƒ“ãƒ«ãƒ‰æ™‚é–“ã®æ¸¬å®šçµæœã¨åˆ†æ

### æ¸¬å®šãƒ‡ãƒ¼ã‚¿
| ãƒ•ã‚§ãƒ¼ã‚º | åˆå›ãƒ“ãƒ«ãƒ‰ | ã‚­ãƒ£ãƒƒã‚·ãƒ¥åˆ©ç”¨æ™‚ | æ”¹å–„ç‡ |
|---------|-----------|----------------|--------|
| Dockerãƒ“ãƒ«ãƒ‰ï¼ˆCommandï¼‰ | 9åˆ†21ç§’ | 16-18ç§’ | 96.8% |
| Dockerãƒ“ãƒ«ãƒ‰ï¼ˆQueryï¼‰ | 9åˆ†1ç§’ | 16-18ç§’ | 96.7% |
| SAMãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ³ã‚° | ç´„30ç§’ | ç´„30ç§’ | - |
| å…¨ä½“ï¼ˆç›®æ¨™ï¼‰ | 3åˆ†ä»¥å†… | - | æœªé”æˆ* |

*Lambdaäº’æ›æ€§ã‚¨ãƒ©ãƒ¼ã«ã‚ˆã‚Šãƒ‡ãƒ—ãƒ­ã‚¤å¤±æ•—ã®ãŸã‚

### æˆåŠŸã—ãŸæœ€é©åŒ–
1. **BuildKitã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¦ãƒ³ãƒˆ**
   - `/root/.cache`ã¨`.build`ã‚’ã‚­ãƒ£ãƒƒã‚·ãƒ¥
   - Swiftãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®å†ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å›é¿

2. **ECRãƒ¬ã‚¸ã‚¹ãƒˆãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥**
   - ä¸­é–“ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚’ECRã«ä¿å­˜ï¼ˆmode=maxï¼‰
   - ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯çµŒç”±ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥å…±æœ‰

3. **ä¸¦åˆ—ãƒ“ãƒ«ãƒ‰æœ€é©åŒ–**
   - `-Xswiftc -j8 -enable-batch-mode`
   - ãƒãƒ«ãƒã‚³ã‚¢ã‚’æ´»ç”¨ã—ãŸé«˜é€ŸåŒ–

### ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹è©•ä¾¡
- **ãƒ“ãƒ«ãƒ‰æ™‚é–“**: ç›®æ¨™ã‚’å¤§å¹…ã«ä¸Šå›ã‚‹æ”¹å–„ï¼ˆ3åˆ†â†’18ç§’ï¼‰
- **è²»ç”¨å¯¾åŠ¹æœ**: ãƒ“ãƒ«ãƒ‰æ™‚é–“çŸ­ç¸®ã§ç´„70%ã®ã‚³ã‚¹ãƒˆå‰Šæ¸›
- **é–‹ç™ºåŠ¹ç‡**: é«˜é€Ÿãªãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ãƒ«ãƒ¼ãƒ—ã‚’å®Ÿç¾

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ï¼ˆå„ªå…ˆé †ä½é †ï¼‰

1. **Lambdaäº’æ›æ€§å•é¡Œã®è§£æ±º** ğŸš¨
   - ã‚¢ãƒ—ãƒ­ãƒ¼ãƒå¤‰æ›´: Lambda Web Adapter â†’ Swift AWS Lambda Runtime
   - Dockerfileã®å…¨é¢çš„ãªè¦‹ç›´ã—
   - ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®SAM localå‹•ä½œç¢ºèªã‚’å…ˆã«å®Ÿæ–½

2. **ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸå¾Œã®æ¤œè¨¼**
   - ç‹¬ç«‹ãƒ‡ãƒ—ãƒ­ã‚¤ã®å‹•ä½œç¢ºèª
   - "v2 (Fast Deploy)"ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®è¡¨ç¤ºç¢ºèª
   - å…¨ä½“ã®ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰æ™‚é–“æ¸¬å®š

3. **é‹ç”¨æº–å‚™**
   - æ—§ãƒªã‚½ãƒ¼ã‚¹ã®å‰Šé™¤ï¼ˆçµ±åˆãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ç­‰ï¼‰
   - ç›£è¦–ãƒ»ã‚¢ãƒ©ãƒ¼ãƒˆã®è¨­å®š
   - ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã®æœ€çµ‚æ›´æ–°

4. **è¿½åŠ ã®æœ€é©åŒ–æ¤œè¨**
   - ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸ã®äº‹å‰ãƒ“ãƒ«ãƒ‰
   - ã‚ˆã‚Šç©æ¥µçš„ãªã‚­ãƒ£ãƒƒã‚·ãƒ¥æˆ¦ç•¥
   - ãƒ“ãƒ«ãƒ‰ä¸¦åˆ—åº¦ã®ã•ã‚‰ãªã‚‹èª¿æ•´

## ä»Šå›ã®ä½œæ¥­ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¾ã¨ã‚ï¼ˆ2025å¹´7æœˆ10æ—¥ 01:00-10:50ï¼‰

### å®Ÿæ–½å†…å®¹
1. **Lambdaäº’æ›æ€§ã‚¨ãƒ©ãƒ¼ã®è©³ç´°èª¿æŸ»ã¨è¤‡æ•°ã®å¯¾ç­–è©¦è¡Œ**
   - SAMãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã¸ã®ImageConfigè¿½åŠ ï¼ˆEntryPoint, Command, WorkingDirectoryï¼‰
   - Lambda Web Adapterã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—ï¼ˆ0.9.0â†’0.9.1ï¼‰
   - ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸ã®å¤‰æ›´è©¦è¡Œï¼ˆUbuntuâ†’AWS LambdaåŸºæœ¬ã‚¤ãƒ¡ãƒ¼ã‚¸â†’Ubuntu 22.04ï¼‰
   - Dockerfileã®å„ç¨®èª¿æ•´ï¼ˆchmod +xã€ãƒ‘ã‚¹ä¿®æ­£ã€ENVè¨­å®šç­‰ï¼‰
   - BuildSpecä¿®æ­£ï¼ˆBuildKitã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¦ãƒ³ãƒˆå‰Šé™¤ï¼‰

2. **ç‹¬ç«‹ãƒ‡ãƒ—ãƒ­ã‚¤ã‚·ã‚¹ãƒ†ãƒ ã®å‹•ä½œç¢ºèª**
   - Command/Queryä¸¡ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãŒç‹¬ç«‹ã—ã¦å‹•ä½œã™ã‚‹ã“ã¨ã‚’ç¢ºèª
   - git pushã§è‡ªå‹•çš„ã«ä¸¡ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãŒèµ·å‹•
   - ãƒ“ãƒ«ãƒ‰ãƒ•ã‚§ãƒ¼ã‚ºã¾ã§ã¯æ­£å¸¸ã«å‹•ä½œ

3. **ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ã«ã‚ˆã‚‹å¤‰æ›´è¿½è·¡**
   - Command Server: v2 - Adapter Path Fix
   - Query Server: v4 - Lambda Adapter Path Fix

### æŠ€è¡“çš„ãªç™ºè¦‹äº‹é …
1. **BuildKitã®åˆ¶ç´„**
   - CodeBuildç’°å¢ƒã§BuildKitãŒåˆ©ç”¨ä¸å¯ï¼ˆbuildxã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆæ¬ å¦‚ï¼‰
   - `--mount=type=cache`ã‚’å‰Šé™¤ã—ã¦é€šå¸¸ã®docker buildã«å¤‰æ›´

2. **AWS LambdaåŸºæœ¬ã‚¤ãƒ¡ãƒ¼ã‚¸ã®å•é¡Œ**
   - `public.ecr.aws/lambda/provided:al2023-arm64`ä½¿ç”¨æ™‚ã«Swiftä¾å­˜é–¢ä¿‚ã§ãƒ“ãƒ«ãƒ‰å¤±æ•—
   - dnfãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã§ã®ä¾å­˜é–¢ä¿‚è§£æ±ºã«å•é¡Œ

3. **ã‚¤ãƒ¡ãƒ¼ã‚¸æ¤œè¨¼ã‚¨ãƒ©ãƒ¼ã®ç¶™ç¶š**
   - æ§˜ã€…ãªå¯¾ç­–ã‚’è©¦ã¿ãŸãŒã€ŒSource image is not validã€ã‚¨ãƒ©ãƒ¼ãŒè§£æ±ºã›ãš
   - ã‚¨ãƒ©ãƒ¼ã¯ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ä¸ä¸€è‡´ã§ã¯ãªã„ï¼ˆarm64ã§çµ±ä¸€æ¸ˆã¿ï¼‰
   - Lambda Web Adapterã¨Lambdaã‚µãƒ¼ãƒ“ã‚¹ã®äº’æ›æ€§ã«æ ¹æœ¬çš„ãªå•é¡ŒãŒã‚ã‚‹å¯èƒ½æ€§

### è©³ç´°ãªèª¿æŸ»çµæœï¼ˆã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£äº’æ›æ€§ï¼‰

#### âœ… æ­£ã—ãè¨­å®šã•ã‚Œã¦ã„ã‚‹é …ç›®
1. **ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£è¨­å®š**
   - SAMãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ: `arm64`æŒ‡å®šæ¸ˆã¿
   - CodeBuildãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆ: `ARM_CONTAINER`ç’°å¢ƒ
   - Dockerã‚¤ãƒ¡ãƒ¼ã‚¸: `arm64`ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã§æ­£å¸¸ã«ãƒ“ãƒ«ãƒ‰
   - æ—¢å­˜ã®Lambdaé–¢æ•°: `arm64`ã§å‹•ä½œä¸­

2. **ECRãƒªãƒã‚¸ãƒˆãƒªè¨­å®š**
   - ãƒªãƒã‚¸ãƒˆãƒªãƒãƒªã‚·ãƒ¼: Lambdaæ¨©é™è¨­å®šæ¸ˆã¿
   - ã‚¤ãƒ¡ãƒ¼ã‚¸å½¢å¼: `application/vnd.docker.distribution.manifest.v2+json`
   - ã‚¤ãƒ¡ãƒ¼ã‚¸ã‚µã‚¤ã‚º: ç´„112MBï¼ˆé©æ­£ç¯„å›²ï¼‰

3. **Dockerã‚¤ãƒ¡ãƒ¼ã‚¸ã®å‹•ä½œç¢ºèª**
   - ãƒ­ãƒ¼ã‚«ãƒ«ã§ã®docker run: æ­£å¸¸å‹•ä½œ
   - Lambda Web Adapter: `/opt/extensions/lambda-adapter`ã«å­˜åœ¨
   - ENTRYPOINT/CMD: æ­£ã—ãè¨­å®š

#### âŒ å•é¡Œã®æ ¸å¿ƒ
- **ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸**: "Source image is not valid"
- **ç™ºç”Ÿã‚¿ã‚¤ãƒŸãƒ³ã‚°**: CloudFormationã§Lambdaé–¢æ•°ã‚’ä½œæˆ/æ›´æ–°æ™‚
- **ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã¯å•é¡Œãªã—**: arm64ã§çµ±ä¸€ã•ã‚Œã¦ã„ã‚‹

### åˆ¤æ˜ã—ãŸå•é¡Œã®è©³ç´°åˆ†æ

#### Lambdaäº’æ›æ€§ã‚¨ãƒ©ãƒ¼ã®çœŸã®åŸå› 
1. **ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®å•é¡Œã§ã¯ãªã„**
   - arm64ã§å®Œå…¨ã«çµ±ä¸€ã•ã‚Œã¦ãŠã‚Šã€è¨­å®šãƒŸã‚¹ã¯ãªã„
   - æ—¢å­˜ã®é–¢æ•°ã‚‚arm64ã§æ­£å¸¸å‹•ä½œã—ã¦ã„ã‚‹

2. **Lambda Web Adapterã®åˆ¶é™ã®å¯èƒ½æ€§**
   - Lambda Web Adapterã‚’ä½¿ç”¨ã—ãŸã‚¤ãƒ¡ãƒ¼ã‚¸ãŒLambdaã‚µãƒ¼ãƒ“ã‚¹ã®æ¤œè¨¼ã‚’é€šéã§ããªã„
   - ImageConfigè¨­å®šã‚’è¿½åŠ ã—ã¦ã‚‚è§£æ±ºã—ãªã„

3. **è€ƒãˆã‚‰ã‚Œã‚‹åŸå› **
   - Lambda Runtime APIã¨ã®çµ±åˆæ–¹æ³•ã®å•é¡Œ
   - ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚„ãƒ¬ã‚¤ãƒ¤ãƒ¼æ§‹é€ 
   - Lambda Web Adapterã®åˆæœŸåŒ–ãƒ—ãƒ­ã‚»ã‚¹

### ç‹¬ç«‹ãƒ‡ãƒ—ãƒ­ã‚¤ã‚·ã‚¹ãƒ†ãƒ ã®çŠ¶æ…‹

#### âœ… æˆåŠŸã—ã¦ã„ã‚‹éƒ¨åˆ†
1. **ç‹¬ç«‹ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å‹•ä½œ**
   - Command/Queryåˆ¥ã€…ã®ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ãŒä¸¦åˆ—å®Ÿè¡Œ
   - å¤‰æ›´æ¤œçŸ¥ã‚·ã‚¹ãƒ†ãƒ ã¯æ­£å¸¸ï¼ˆä»Šå›ã¯ä¸¡æ–¹å®Ÿè¡Œï¼‰
   - ãƒ“ãƒ«ãƒ‰ãƒ•ã‚§ãƒ¼ã‚ºã¯æˆåŠŸ

2. **ãƒ“ãƒ«ãƒ‰é«˜é€ŸåŒ–**
   - åˆå›: ç´„10åˆ†ï¼ˆSwiftä¾å­˜é–¢ä¿‚ã®è§£æ±ºå«ã‚€ï¼‰
   - ã‚­ãƒ£ãƒƒã‚·ãƒ¥åˆ©ç”¨æ™‚: 16-18ç§’ï¼ˆå‰å›ç¢ºèªæ¸ˆã¿ï¼‰
   - ç›®æ¨™ã®3åˆ†ã‚’å¤§å¹…ã«ã‚¯ãƒªã‚¢

#### âŒ æ®‹ã£ã¦ã„ã‚‹èª²é¡Œ
- **ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ•ã‚§ãƒ¼ã‚ºã®å¤±æ•—**: Lambdaäº’æ›æ€§ã‚¨ãƒ©ãƒ¼ã§åœæ­¢
- **æœ¬ç•ªç’°å¢ƒã¸ã®åæ˜ ä¸å¯**: å¤ã„ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒç¨¼åƒç¶™ç¶š

### æ¨å¥¨ã•ã‚Œã‚‹æ–¹å‘è»¢æ›ï¼ˆè©³ç´°ç‰ˆï¼‰

#### 1. Swift AWS Lambda Runtimeã¸ã®ç§»è¡Œ
**ç†ç”±**:
- Lambda Runtime APIã¨ã®ç›´æ¥çµ±åˆã§ã‚ˆã‚Šç¢ºå®Ÿ
- å…¬å¼ã‚µãƒãƒ¼ãƒˆã§å®Ÿç¸¾ã‚ã‚Š
- Lambda Web Adapterã®åˆ¶é™ã‚’å›é¿

**å®Ÿè£…æ–¹é‡**:
```swift
// ç¾åœ¨: Vapor + Lambda Web Adapter
// ç§»è¡Œå¾Œ: Vapor + Swift Lambda Runtime
import AWSLambdaRuntime
import Vapor

@main
struct LambdaHandler: SimpleLambdaHandler {
    func handle(_ event: APIGatewayV2Request, context: LambdaContext) async throws -> APIGatewayV2Response {
        // Vaporã‚¢ãƒ—ãƒªã‚’ãƒ©ãƒƒãƒ—
    }
}
```

#### 2. æ®µéšçš„ç§»è¡Œè¨ˆç”»
1. **Phase 1: æ¤œè¨¼ç’°å¢ƒæ§‹ç¯‰**
   - æœ€å°é™ã®Swift Lambda Runtimeã‚µãƒ³ãƒ—ãƒ«ä½œæˆ
   - SAM localã§ã®å‹•ä½œç¢ºèª
   - ECRã¸ã®ãƒ—ãƒƒã‚·ãƒ¥ã¨Lambdaãƒ‡ãƒ—ãƒ­ã‚¤ãƒ†ã‚¹ãƒˆ

2. **Phase 2: Vaporçµ±åˆ**
   - Vaporã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’Lambdaãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã§ãƒ©ãƒƒãƒ—
   - ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã¨ãƒªã‚¯ã‚¨ã‚¹ãƒˆå‡¦ç†ã®çµ±åˆ
   - ãƒ­ãƒ¼ã‚«ãƒ«ãƒ†ã‚¹ãƒˆã®å®Ÿæ–½

3. **Phase 3: æœ¬ç•ªç§»è¡Œ**
   - Command/Queryã‚µãƒ¼ãƒãƒ¼ã¸ã®é©ç”¨
   - ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆ
   - æ®µéšçš„ãƒ­ãƒ¼ãƒ«ã‚¢ã‚¦ãƒˆ

### ç¾åœ¨ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆçŠ¶æ…‹ã‚µãƒãƒªãƒ¼

#### é”æˆæ¸ˆã¿
- âœ… ç‹¬ç«‹ãƒ‡ãƒ—ãƒ­ã‚¤ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æ§‹ç¯‰
- âœ… ãƒ“ãƒ«ãƒ‰é«˜é€ŸåŒ–ï¼ˆ10åˆ†â†’18ç§’ï¼‰
- âœ… å¤‰æ›´æ¤œçŸ¥ã‚·ã‚¹ãƒ†ãƒ 
- âœ… ä¸¦åˆ—ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ

#### æœªé”æˆ
- âŒ Lambdaäº’æ›æ€§å•é¡Œã®è§£æ±º
- âŒ 3åˆ†ä»¥å†…ã®å®Œå…¨ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆãƒ“ãƒ«ãƒ‰ã¯é”æˆã€ãƒ‡ãƒ—ãƒ­ã‚¤ã§å¤±æ•—ï¼‰
- âŒ æœ¬ç•ªç’°å¢ƒã¸ã®æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³åæ˜ 

### æ¬¡å›ä½œæ¥­ã¸ã®å…·ä½“çš„ãªå¼•ãç¶™ãäº‹é …

1. **æœ€å„ªå…ˆã‚¿ã‚¹ã‚¯**
   - Lambda Web Adapterã®å•é¡Œè§£æ±ºã¾ãŸã¯Swift AWS Lambda Runtimeã¸ã®ç§»è¡Œ
   - æœ€å°é™ã®ã‚µãƒ³ãƒ—ãƒ«ã§Lambdaãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸã‚’ç¢ºèª
   - ç¾åœ¨ã®ã‚³ãƒŸãƒƒãƒˆ: `bc15356` (Ubuntu 22.04ãƒ™ãƒ¼ã‚¹ã€/var/taskæ§‹é€ )

2. **æ¤œè¨¼ã™ã¹ãä»®èª¬**
   - Lambda Web Adapterã®Swift/Vaporäº’æ›æ€§ã«å•é¡ŒãŒã‚ã‚‹
   - ã‚¤ãƒ¡ãƒ¼ã‚¸ã®ãƒ¡ã‚¿ãƒ‡ãƒ¼ã‚¿ã‚„ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆå½¢å¼ãŒè¦å› 
   - Swift Lambda Runtimeãªã‚‰å•é¡Œãªããƒ‡ãƒ—ãƒ­ã‚¤å¯èƒ½

3. **ä¿æŒã™ã¹ãæ”¹å–„**
   - ç‹¬ç«‹ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³æ§‹æˆï¼ˆæ­£å¸¸å‹•ä½œç¢ºèªæ¸ˆã¿ï¼‰
   - å¤‰æ›´æ¤œçŸ¥ã‚·ã‚¹ãƒ†ãƒ ï¼ˆæœªãƒ†ã‚¹ãƒˆã ãŒå®Ÿè£…æ¸ˆã¿ï¼‰
   - ãƒ“ãƒ«ãƒ‰é«˜é€ŸåŒ–è¨­å®šï¼ˆBuildKitã‚­ãƒ£ãƒƒã‚·ãƒ¥ã¯ç¾åœ¨ç„¡åŠ¹åŒ–ä¸­ï¼‰

4. **æ³¨æ„ç‚¹**
   - ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ï¼ˆarm64ï¼‰ã®è¨­å®šã¯æ­£ã—ã„ã®ã§å¤‰æ›´ä¸è¦
   - ECRãƒªãƒã‚¸ãƒˆãƒªãƒãƒªã‚·ãƒ¼ã‚‚æ­£ã—ãè¨­å®šæ¸ˆã¿
   - å•é¡Œã¯ã‚¤ãƒ¡ãƒ¼ã‚¸å½¢å¼/Runtime APIçµ±åˆã«ã‚ã‚‹
   - BuildKitãŒä½¿ãˆãªã„ç’°å¢ƒã§ã®æœ€é©åŒ–ãŒå¿…è¦

5. **ç¾åœ¨ã®Dockerfileæ§‹æˆ**
   - ãƒ™ãƒ¼ã‚¹ã‚¤ãƒ¡ãƒ¼ã‚¸: `ubuntu:22.04`ï¼ˆarm64ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ æŒ‡å®šï¼‰
   - Lambda Web Adapter: v0.9.1
   - ä½œæ¥­ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: `/var/task`ï¼ˆLambdaæ¨™æº–ï¼‰
   - å®Ÿè¡Œæ¨©é™ä»˜ä¸æ¸ˆã¿ï¼ˆchmod +xï¼‰

6. **è©¦è¡Œæ¸ˆã¿ã§å¤±æ•—ã—ãŸå¯¾ç­–ãƒªã‚¹ãƒˆ**
   - ImageConfigï¼ˆEntryPoint, Command, WorkingDirectoryï¼‰ã®è¨­å®š
   - Lambda Web Adapterãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—
   - AWS LambdaåŸºæœ¬ã‚¤ãƒ¡ãƒ¼ã‚¸ã¸ã®å¤‰æ›´
   - å„ç¨®Dockerfileãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®èª¿æ•´
   - ENVãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å¤‰æ›´ï¼ˆPORT, AWS_LWA_PORT, AWS_LWA_INVOKE_MODEç­‰ï¼‰